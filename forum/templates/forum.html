{% extends 'base.html' %}

{% block meta %}
    <title>Restore the Shore | Forum</title>
    <script>
        $(document).ready(function(){
            $.get(window.location.href + "json/", function (data) {
                for(i = 0; i < data.length; i++){
                    showPost(data[i]);
                }
            });

            function showPost(data){
                $("#forum-posts").append(
                    `
                        <div class="post" id="post-${data.pk}">
                            <div class="post-header">${data.fields.creator.username}</div>
                                <div class="post-body">
                                    <img src=${data.fields.image} class="post-image"/>
                                    <p class="post-content">${data.fields.content}</p>
                                </div>
                            <div class="post-footer text-muted">Posted on ${data.fields.date}</div>
                        </div>
                    `
                );
            } 
            
            $("#new-form-post").submit(function(e){
                e.preventDefault();

                $.post( window.location.href + "add_post/", {
                    content: $("#content").val(),
                    image: $("#image").val()
                }).done(function(data){
                    ShowPost(data);

                    const posts = document.getElementById("forum-posts");
                    posts.insertAdjacentElement("beforestart", `#post-${data.pk}`);
                });

                $("#staticBackdrop").modal("hide");
            });

        });
        
    </script>
    
{% endblock meta %}

{% block content %}

    <!-- Infinite Posts -->
    <div class="forum-posts" id="forum-posts"></div>

    <!-- Create New Post Modal Button -->
    <button
        type="button"
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#staticBackdrop"
    >
        +
    </button>

    <!-- Create New Post Modal -->
    <div
        class="modal fade"
        id="staticBackdrop"
        data-bs-backdrop="static"
        data-bs-keyboard="false"
        tabindex="-1"
        aria-labelledby="staticBackdropLabel"
        aria-hidden="true"
    >
        <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">Add A New Post</h1>
            <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
            ></button>
            </div>

            <div class="modal-body">
                <form id="new-post-form" method="POST">
                    {% csrf_token %}

                    <div id="image-group" class="form-group">
                        <label for="image">Image</label>
                        <input
                            type="url"
                            class="form-control"
                            id="image"
                            onchange="loadFile(event)"
                            placeholder="Enter image link"
                        />
 
                        <div>
                            <br>
                            <img id="output"/>
                        </div>
                        <script>
                            var loadFile = function(event) {
                                var output = document.getElementById("output");
                                var link = document.getElementById("image").value;
                                output.src = link;
                            };
                        </script>
                    </div>

                    <div id="content-group" class="form-group">
                        <label for="content">Content</label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="content"
                            name="content" 
                            placeholder="Write your text here"
                        />
                    </div>

                    <br>

                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                    >
                        Close
                    </button>
                    <input type="submit" class="btn btn-primary" value="Submit" />
                </form>
            </div>
        </div>
        </div>
    </div>

{% endblock content %}